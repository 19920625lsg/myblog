if(typeof jQuery!="function"){throw new Error("mPlayer插件需要jQuery支持")}(function(a){function b(c){$this=this;$this.settings={playMode:0,playList:0,playSong:5,autoPlay:false,playRotate:true,useDefaultStyle:true,lrcHeight:160,};$this.init(c);$this.dataList();$this.bindEvents();$this.play($this.settings.playList,$this.settings.playSong)}b.prototype.dataList=function(){$this=this;$this.songArr=[];for(var e=0;e<$this.settings.songList.length;e++){var h="",g="";$this.songArr.push([]);for(var d=0;d<$this.settings.songList[e].length;d++){if($this.settings.songList[e][d].basic){var c=$this.settings.songList[e][d].name;$this.doms.list.append(a("<li>").html(c));h=$this.settings.songList[e][d].singer||"";g=$this.settings.songList[e][d].img||"";$this.songArr[e].listName=c}else{var l=$this.settings.songList[e][d].singer||h,f=$this.settings.songList[e][d].img||g,k=$this.settings.songList[e][d].name;$this.songArr[e].push({"singer":l,"image":f,"name":k,"src":$this.settings.songList[e][d].src,"lrc":$this.settings.songList[e][d].lrc})}}}};b.prototype.init=function(d){$this=this;a.extend($this.settings,d);if(!$this.settings.containerSelector){throw new Error("您未填写容器选择器(containerSelector)配置")}if(!$this.settings.songList){throw new Error("您未填写歌曲列表(songList)配置")}a($this.settings.containerSelector).append('<div id="mp-container" class="mp"><div class="mp-playbox"><div id="mp-cover" class="mp-cover"><img src="#" alt="cover" id="mp-cover-img"></div><div class="mp-playing-name" id="mp-playing-name"><h2>歌名<small>歌手</small></h2></div><div class="mp-progress"><div class="mp-progress-total" id="mp-play-progress-total"><div class="mp-progress-current" id="mp-play-progress-current"></div></div><div class="mp-progress-time"><span id="mp-play-progress-currenttime">00:00</span>/<span id="mp-play-progress-alltime">00:00</span></div></div><div class="mp-control"><div class="mp-buttonbox"><a href="javascript:void(0);" class="mp-button mp-hover" id="mp-button-prev">&#xe90b;</a><a href="javascript:void(0);" class="mp-button mp-hover mp-button-play" id="mp-button-play">&#xe908;</a><a href="javascript:void(0);" class="mp-button mp-hover" id="mp-button-next">&#xe90c;</a></div><div id="mp-modebox" class="mp-modebox"><a href="javascript:void(0);" class="mp-mode-button mp-hover">&#xe040;</a><a href="javascript:void(0);" class="mp-mode-button mp-hover">&#xe041;</a><a href="javascript:void(0);" class="mp-mode-button mp-hover">&#xe043;</a></div><a href="javascript:void(0);" class="mp-menu-switch mp-hover" id="mp-menu-switch" >&#xe901;</a><div class="mp-volbox"><a href="javascript:void(0);" class="mp-vol-mute mp-icon mp-hover" id="mp-vol-mute">&#xe903;</a><input type="range" id="mp-vol-range" class="mp-vol-range" min="0" max="100" value="100"></div></div></div><div id="mp-lrcbox" class="mp-lrc-box"><ul id="mp-lrc-wrap" class="mp-lrc-wrap"></ul></div><div class="mp-listbox"><div id="mp-list-select" class="mp-list-select"><h3 class="mp-list-title">播放列表</h3><ul id="mp-list-select-ul" class="mp-list-select-ul"></ul></div><ul id="mp-list" class="mp-list"></ul></div></div>');$this.doms={mp:a("#mp-container"),lrc:a("#mp-lrc-wrap"),lrcBox:a("#mp-lrcbox"),listtitle:a("#mp-list-select h3"),title:a("#mp-playing-name"),list:a("#mp-list-select-ul"),musicList:a("#mp-list"),process:a("#mp-play-progress-current"),bufferProcess:a("#mp-play-progress-buffer"),totalProcess:a("#mp-play-progress-total"),cover:a("#mp-cover-img"),coverBox:a("#mp-cover"),playbutton:a("#mp-button-play"),prevbutton:a("#mp-button-prev"),nextbutton:a("#mp-button-next"),modebox:a("#mp-modebox"),modebuttons:a("#mp-modebox").find("a"),listSelect:a("#mp-list-select-ul"),volume:a("#mp-vol-mute"),volRange:a("#mp-vol-range")};$this.doms.modebuttons.eq($this.settings.playMode).addClass("mp-deep");$this.audiodom=a("<audio></audio>").attr({"preload":"preload","data-playmode":$this.settings.playMode,"data-currentlist":$this.settings.playList,"data-currentsong":$this.settings.playSong,"data-currentLrc":0,"data-displayList":0});$this.tools={rand:function(i,h){if(!h){h=i;i=0}var j=0;do{j=Math.round(Math.random()*h)}while(j<i);return j},fillByZero:function(h,k){h=String(h);for(var j=h.length;j<k;j++){h="0"+h}return h}};if($this.settings.useDefaultStyle){var f=$this.settings.lrcHeight;$this.doms.lrcBox.height(f);var g=160+f;$this.doms.mp.height(g);var e=Math.max((f-40)/2,0);$this.doms.lrc.css({marginTop:e,marginBottom:e});var c=Math.min(g-100,400);a("head").append("<style>.mp-list-on .mp-listbox{height:"+c+"px}</style>");$this.doms.musicList.height(c-40)}};b.prototype.bindEvents=function(){$this=this;$this.audiodom.bind("canplay",function(){if($this.settings.autoPlay){a(this).get(0).play()}$this.settings.autoPlay=true;var f=a(this).prop("duration");$this.setTime(f,"mp-play-progress-alltime");if($this.settings.canPlay){var c=parseInt($this.audiodom.attr("data-currentList"));var d=parseInt($this.audiodom.attr("data-currentSong"));var e=$this.songArr[c][d];$this.settings.canPlay({name:e.name,singer:e.singer,duration:f})}}).bind("play",function(){if($this.settings.playRotate){$this.doms.coverBox.addClass("mp-cover-animate")}$this.doms.playbutton.html("&#xe909;")}).bind("pause",function(){$this.doms.coverBox.removeClass("mp-cover-animate");$this.doms.playbutton.html("&#xe908;")}).bind("ended",function(){$this.toNext()}).bind("timeupdate",function(f){var c=$this.audiodom.prop("timeArr");var e=Math.round(a(this).prop("currentTime")*1000);for(var d=0;d<c.length;d++){if(e<=c[d]){break}}d--;if(parseInt($this.audiodom.attr("data-currentLrc"))!==d){$this.audiodom.attr("data-currentLrc",d);$this.doms.lrcBox.animate({scrollTop:d*32},500);a("#mp-lrc-wrap").find(".mp-lrc-current").removeClass("mp-lrc-current");a("#mp-lrc-"+c[d]).addClass("mp-lrc-current")}$this.doms.process.css("width",a(this).prop("currentTime")/a(this).prop("duration")*100+"%");$this.setTime(a(this).prop("currentTime"),"mp-play-progress-currenttime")});$this.doms.playbutton.on("click",function(){if($this.audiodom.get(0).paused){$this.audiodom.get(0).play()}else{$this.audiodom.get(0).pause()}});$this.doms.prevbutton.on("click",function(){var e=parseInt($this.audiodom.attr("data-playmode"));var d=parseInt($this.audiodom.attr("data-currentsong"));var c=parseInt($this.audiodom.attr("data-currentlist"));if(e==2){$this.rand(c,d)}else{$this.prev(c,d)}});$this.doms.nextbutton.on("click",function(){var e=parseInt($this.audiodom.attr("data-playmode"));var d=parseInt($this.audiodom.attr("data-currentsong"));var c=parseInt($this.audiodom.attr("data-currentlist"));if(e==2){$this.rand(c,d)}else{$this.next(c,d)}});$this.doms.modebox.on("click","a",function(){$this.doms.modebuttons.removeClass("mp-deep");a(this).addClass("mp-deep");$this.audiodom.attr("data-playmode",a(this).index())});$this.doms.totalProcess.click(function(e){var c=e.offsetX;var d=c/a(this).width();d=d>100?100:d;var f=$this.audiodom.prop("duration");$this.audiodom.prop("currentTime",f*d)});$this.doms.volRange.on("change",function(){var c=a(this).val()/100;$this.audiodom.prop("volume",c);if(c>=0.8){ico="&#xe903"}else{if(c>=0.3&&c<0.8){ico="&#xe904"}else{if(c>0&&c<0.3){ico="&#xe905"}else{if(c===0){ico="&#xe906"}}}}$this.doms.volume.html(ico)});$this.doms.volume.on("click",function(){if($this.doms.volume.hasClass("mp-disabled")){$this.doms.volume.removeClass("mp-disabled");$this.doms.volRange.removeAttr("disabled").trigger("change")}else{$this.doms.volume.addClass("mp-disabled");$this.doms.volume.html("&#xe907");$this.audiodom.prop("volume",0);$this.doms.volRange.attr("disabled","disabled")}});a("#mp-menu-switch").on("click",function(){$this.doms.mp.toggleClass("mp-list-on")});$this.doms.listtitle.on("click",function(){a("#mp-list-select").toggleClass("mp-list-select-on")});$this.doms.listSelect.on("click","li",function(){$this.changeList(a(this).index());a(this).parent().parent().removeClass("mp-list-select-on")});$this.doms.musicList.on("click","li",function(){$this.doms.mp.removeClass("mp-list-on");$this.play(parseInt($this.audiodom.attr("data-displayList")),a(this).index())})};b.prototype.play=function(d,e){$this=this;var c=$this.songArr[d][e];$this.audiodom.attr({src:c.src,"data-currentsong":e,"data-currentlist":d});$this.doms.lrcBox.animate({scrollTop:0},500);$this.doms.cover.attr("src",c.image);$this.doms.title.html("<h2>"+c.name+"<small>"+c.singer+"</small></h2>");$this.changeList(d);$this.setLrc(c.lrc);$this.audiodom.attr("data-currentLrc",0);if($this.settings.beforePlay){$this.settings.beforePlay(c)}};b.prototype.changeList=function(d){$this=this;$this.doms.listtitle.html($this.songArr[d].listName);$this.doms.musicList.html("");for(var c=0;c<$this.songArr[d].length;c++){$this.doms.musicList.append(a("<li>").html($this.songArr[d][c].name+" - "+$this.songArr[d][c].singer).addClass("mp-list-song"))}$this.audiodom.attr("data-displayList",d);if(parseInt($this.audiodom.attr("data-currentlist"))===d){var e=$this.audiodom.attr("data-currentsong");a("#mp-list").find("li").eq(e).addClass("mp-list-song-current")}};b.prototype.setTime=function(g,e){$this=this;var f=$this.tools;var d=f.fillByZero(parseInt(g/60),2);g-=d*60;var c=f.fillByZero(Math.round(g),2);a("#"+e).html(d+":"+c)};b.prototype.setLrc=function(e){$this=this;var f=/\[(\d{2}):(\d{2})\.(\d{2})\]([^\n\r]*)/g;var i={};while(true){var d=f.exec(e);if(!d){break}var h=Math.round((parseInt(d[1])*60+parseInt(d[2])+parseInt(d[3])/100)*1000);i[h]=a.trim(d[4])}var c=[];$this.doms.lrc.html("");for(var g in i){$this.doms.lrc.append(a("<li>").html(i[g]||" ").addClass("mp-lrc").attr("id","mp-lrc-"+g));c.push(parseInt(g))}$this.doms.lrc.children().eq(0).addClass("mp-lrc-current");$this.audiodom.prop("timeArr",c)};b.prototype.prev=function(c,d){$this=this;d--;if(d<0){d=$this.songArr[c].length-1}$this.play(c,d)};b.prototype.next=function(c,d){$this=this;d++;if(d>=$this.songArr[c].length){d=0}$this.play(c,d)};b.prototype.rand=function(c,e){$this=this;var d=e;do{e=$this.tools.rand($this.songArr[c].length-1)}while(e===d);$this.play(c,e)};b.prototype.repeat=function(c,d){$this=this;$this.play(c,d)};b.prototype.toNext=function(){$this=this;var e=parseInt($this.audiodom.attr("data-playmode"));var d=parseInt($this.audiodom.attr("data-currentsong"));var c=parseInt($this.audiodom.attr("data-currentlist"));switch(e){case 1:$this.repeat(c,d);break;case 2:$this.rand(c,d);break;default:$this.next(c,d);break}};window.MPlayer=b})(jQuery);